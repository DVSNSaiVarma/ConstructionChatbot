<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Chatbot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        
        #bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #bubble:hover { background: #1d4ed8; }
        
        #window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 1001;
        }
        
        #window.open { display: flex; }
        
        #header {
            background: #2563eb;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        
        #header h3 { font-size: 16px; margin: 0; }
        
        #closebtn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .bot-msg {
            background: white;
            color: #333;
            margin-right: auto;
            border: 1px solid #ddd;
        }
        
        .user-msg {
            background: #2563eb;
            color: white;
            margin-left: auto;
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .optbtn {
            background: white;
            border: 2px solid #2563eb;
            color: #2563eb;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .optbtn:hover {
            background: #2563eb;
            color: white;
        }
        
        #inputbox {
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        
        #input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        #sendbtn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #sendbtn:hover { background: #1d4ed8; }
        
        @media (max-width: 768px) {
            #window { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div id="bubble" onclick="toggleWindow()">
        <svg width="28" height="28" fill="none" stroke="white" viewBox="0 0 24 24">
            <path stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
    </div>

    <div id="window">
        <div id="header">
            <h3>üèóÔ∏è Construction Assistant</h3>
            <button id="closebtn" onclick="toggleWindow()">√ó</button>
        </div>
        <div id="chat"></div>
        <div id="inputbox">
            <input type="text" id="input" placeholder="Type here..." onkeydown="checkEnter(event)">
            <button id="sendbtn" onclick="sendMsg()">Send</button>
        </div>
    </div>

    <script>
        var KEY = 'cwk-336fb085c2af2bc9a9e43d0754120b08ffe7e643ce909c669d4cdd5685b97fc4';
        var SVC = 'construction_ai_chatbot_da6892c4';
        var step = 'start';
        var data = {};
        var started = false;

        function toggleWindow() {
            var w = document.getElementById('window');
            if (w.classList.contains('open')) {
                w.classList.remove('open');
            } else {
                w.classList.add('open');
                if (!started) {
                    started = true;
                    bot('üëã Hello! I am here to help answer your construction questions. What is your name?');
                }
            }
        }

        function bot(msg, opts) {
            var chat = document.getElementById('chat');
            var div = document.createElement('div');
            div.className = 'message bot-msg';
            div.innerHTML = msg;
            
            if (opts) {
                var btnDiv = document.createElement('div');
                btnDiv.className = 'buttons';
                for (var i = 0; i < opts.length; i++) {
                    var b = document.createElement('button');
                    b.className = 'optbtn';
                    b.textContent = opts[i];
                    b.setAttribute('data-value', opts[i]);
                    b.onclick = function() {
                        pickOption(this.getAttribute('data-value'));
                    };
                    btnDiv.appendChild(b);
                }
                div.appendChild(btnDiv);
            }
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function user(msg) {
            var chat = document.getElementById('chat');
            var div = document.createElement('div');
            div.className = 'message user-msg';
            div.textContent = msg;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function typing() {
            var chat = document.getElementById('chat');
            var div = document.createElement('div');
            div.id = 'typing';
            div.className = 'message bot-msg';
            div.textContent = 'Typing...';
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function stopTyping() {
            var t = document.getElementById('typing');
            if (t) t.remove();
        }

        function sendMsg() {
            var inp = document.getElementById('input');
            var msg = inp.value.trim();
            if (!msg) return;
            user(msg);
            inp.value = '';
            handle(msg);
        }

        function checkEnter(e) {
            if (e.key === 'Enter') sendMsg();
        }

        function pickOption(val) {
            user(val);
            handle(val);
        }

        function handle(txt) {
            typing();
            setTimeout(function() {
                stopTyping();
                
                if (step === 'start') {
                    data.name = txt;
                    step = 'email';
                    bot('Nice to meet you, ' + txt + '! üìß What is your email?');
                }
                else if (step === 'email') {
                    if (txt.indexOf('@') < 0) {
                        bot('Please enter a valid email address:');
                        return;
                    }
                    data.email = txt;
                    step = 'phone';
                    bot('Great! üì± What is your phone number?');
                }
                else if (step === 'phone') {
                    data.phone = txt;
                    step = 'type';
                    bot('üèóÔ∏è What type of project?', ['Residential', 'Commercial', 'Renovation', 'Other']);
                }
                else if (step === 'type') {
                    data.type = txt;
                    step = 'question';
                    bot('Perfect! üí¨ What is your question about our services?');
                }
                else if (step === 'question') {
                    data.question = txt;
                    callAPI();
                }
                else if (step === 'followup') {
                    if (txt.toLowerCase().indexOf('yes') >= 0) {
                        step = 'question';
                        bot('What else would you like to know?');
                    } else {
                        bot('Thank you! We will be in touch soon. üëã');
                        step = 'done';
                    }
                }
            }, 800);
        }

        function callAPI() {
            typing();
            
            fetch('https://runtime.codewords.ai/run/' + SVC, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    customer_name: data.name,
                    customer_email: data.email,
                    customer_phone: data.phone,
                    project_type: data.type,
                    question: data.question
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                stopTyping();
                var ans = d.answer;
                
                if (d.sources && d.sources.length > 0) {
                    ans += '<br><br><strong>üìö Sources:</strong>';
                    for (var i = 0; i < d.sources.length; i++) {
                        var s = d.sources[i];
                        var pct = Math.round(s.relevance_score * 100);
                        ans += '<br>‚Ä¢ ' + s.text.substring(0, 100) + '... (' + pct + '%)';
                    }
                }
                
                if (d.escalated && d.escalation_message) {
                    ans += '<br><br>‚úâÔ∏è <em>' + d.escalation_message + '</em>';
                }
                
                bot(ans);
                step = 'followup';
                setTimeout(function() {
                    bot('Do you have another question?', ['Yes', 'No']);
                }, 1000);
            })
            .catch(function(err) {
                stopTyping();
                bot('Sorry, error connecting. Please try again.');
                console.error(err);
            });
        }

        console.log('Chatbot ready!');
    </script>
</body>
</html>